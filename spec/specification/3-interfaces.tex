\chapter{Standard Interfaces} \label{sec:standard interfaces}
\section{Database}
\subsection{Connection}
The central database has a single, continuous, main connection. While it is possible for implementations to provide mechanisms to allow for multiple simultaneous connections, the way this is done is not specified. The database connection must be stable under concurrency conditions; that is to say, database operations from multiple threads must be supported.

\subsubsection{Function \inline{db:connect}}
\funcdef{db:connect}{database-name}{}
Initiates the database connection to the specified database name. Potentially additional information such as host, user and so on are required. These are implementation dependant and will have to be specified through the radiance configuration or some other method unique to the implementation. If the connection should be lost at any point, the implementation is required to re-establish it automatically and silently. Thus the connection must be maintained in one form or another until \inline{CONNECT} is called again or \inline{DISCONNECT} is called. \\

\noindent If the connection fails, an error of type \inline{DATABASE-CONNECTION-FAILED} has to be signalled.

\subsubsection{Function \inline{db:disconnect}}
\funcdef{db:disconnect}{}{}
Terminates the database connection if one is already established. \\

\noindent The implementation may signal a warning of type \inline{DATABASE-CONNECTION-NOT-OPEN} if the connection was already closed at the time of the call.

\subsubsection{Function \inline{db:connected-p}}
\funcdef{db:connected-p}{}{boolean}
Returns \inline{T} if the database is connected, \inline{NIL} otherwise.

\subsection{Collections}
A database has a set of collections, each of which is identified by a unique, extended alphanumeric (a-z,-,\_) name. This name is case-insensitive. \\

A collection is made up of a structure that describes the collection's data layout and the actual data, which comes in records. The implementation is not required to enforce a collection's structure on the data, but may at any time signal an error if operations were to occur that conflict the structure. \\

Additionally, an implementation may support to add indexes on certain fields of the structure. Indexing is not required to be supported, but if it is it may make query operations on the affected fields faster. \\

Each collection has a field called \inline{_id}, which is unique for each record as well as sortable according to sequence of record insertion. More specifically, the \inline{_id} field is sortable in the way that ascending sorting begins with the oldest record first and vice versa. The type used for the field is implementation dependant. \\

Most databases only support a specific range of limited data types, which can be more or less properly matched up with CL types. If they cannot be properly matched, the implementation is required to transform the value as specified. Any implementation is required to support or allow the structure type declarations below. An implementation may or may not support any number of additional data types. 

\subsubsection{Database Structure Type \inline{:INTEGER}}
Stores an object of the CL type \inline{INTEGER}. This type supports an optional extra argument that specifies the amount of bytes used to store the integer. It defaults to 4 and must range between 1-8. If the implementation doesn't support the specified amount of bytes, the type is expected to be upgraded to the next bigger one that contains the range.

\subsubsection{Database Structure Type \inline{:FLOAT}}
Stores an object of the CL type \inline{FLOAT}. The database should always store it as a double-precision floating-point number, according to IEEE. If the precision of the value should exceed that of a double, the value is expected to be truncated.

\subsubsection{Database Structure Type \inline{:CHARACTER}}
Stores an object of the CL type \inline{CHARACTER}. The stored character when retrieved has to be translated into a character of the exact same \inline{CHAR-CODE}.

\subsubsection{Database Structure Type \inline{:VARCHAR}}
Stores an object of the CL type \inline{STRING}. This type requires an extra argument which specifies the maximum number of characters stored. It maps from and to the CL type \inline{STRING}. The same character requirements as for \inline{:CHARACTER} apply.

\subsubsection{Database Structure Type \inline{:TEXT}}
Stores an object of the CL type \inline{STRING}. The string may be of arbitrary length. The same character requirements as for \inline{:CHARACTER} apply.

\subsubsection{Function \inline{db:collections}}
\funcdef{db:collections}{}{list}
Returns a list of strings, each of which is the name of a collection in the database.

\subsubsection{Function \inline{db:create}}
\extfuncdef{db:create}{collection structure \&key indices if-exists}{}{
  collection &---& A string naming the collection. Only a-z,- and \_ are allowed. \\
  structure &::=& \inline{(field*)} \\
  field &::=& \inline{(field-name type)} \\
  type &::=& \inline{type-name | (type-name parameter)} \\
  indices &---& A list of field-names to be indexed. \\
  if-exists &::=& \inline{:error | :ignore}
}
Creates a new collection in the database. If the implementation supports structure, it should define it according to the given \inline{structure} list. The implementation must guarantee that the collection includes a record-unique \inline{_id} field as specified above. \\

\noindent If \inline{if-exists} is set to \inline{:error} and the table exists already, an error of type \\\inline{DATABASE-COLLECTION-ALREADY-EXISTS} is signalled, otherwise the function will silently return.

\subsubsection{Function \inline{db:structure}}
\funcdef{db:structure}{collection}{list}
Returns the structure definition of the collection in the format described in \inline{CREATE}. If the implementation does not support structure, NIL is returned. \\

\noindent If the collection does not exist, an error of type \inline{INEXISTENT-DATABASE-COLLECTION} is signalled.

\subsubsection{Function \inline{db:drop}}
\funcdef{db:drop}{collection}{}
Removes the collection completely, including data, structure, indexes and name. \\

\noindent If the collection does not exist, an error of type \inline{INEXISTENT-DATABASE-COLLECTION} is signalled.

\subsubsection{Function \inline{db:empty}}
\funcdef{db:empty}{collection}{}
Removes all records from the collection. \\

\noindent If the collection does not exist, an error of type \inline{INEXISTENT-DATABASE-COLLECTION} is signalled.

\subsection{Records}

\subsubsection{Function \inline{db:iterate}}
\funcdef{db:iterate}{collection query function \&key fields skip amount sort accumulate}{list or NIL}

\subsubsection{Function \inline{db:select}}
\funcdef{db:select}{collection query \&key fields skip amount sort}{list}

\subsubsection{Function \inline{db:count}}
\funcdef{db:count}{collection query}{integer}

\subsubsection{Function \inline{db:insert}}
\funcdef{db:insert}{collection data}{}

\subsubsection{Function \inline{db:remove}}
\funcdef{db:remove}{collection query \&key skip amount sort}{}

\subsubsection{Function \inline{db:update}}
\funcdef{db:update}{collection query data \&key skip amount sort replace}{}

\subsection{Query Construct}
The database interface exposes a query macro that is required to properly translate expressions into database queries. A database operation only ever affects those records that match the given query (the query evaluates to true). Instead of a query, the \inline{:ALL} keyword may be used if all records should be affected.

\subsubsection{Macro \inline{DB:QUERY}}
\funcdef{db:query}{query-form}{compiled query}
Compiles a query form into a format suitable for the database. \\

The query macro will code-walk and inspect the different arguments. Each query-form may expect either further query-forms or arguments. Arguments will always be evaluated at run-time, with the exception of quoted symbols which will be interpreted as the field of a collection (see the \inline{QUOTE} query-form). An argument can either be a form or an atom. Depending on the evaluated type of the argument the database may perform transformations or signal an error if the type is not supported. Any database implementation has to support in the very least the following types: \inline{string}, \inline{character}, \inline{real} \\

The return value of this macro is completely implementation dependant.
\subsubsection{Query Form \inline{:=}}
\funcdef{:=}{a b}{}
Compares tokens \inline{a} and \inline{b} with each other. This comparison should be the same as \inline{cl:=} for numerical values or \inline{cl:string=} for strings. \inline{a} and \inline{b} must be arguments.
\subsubsection{Query Form \inline{:!=}}
\funcdef{:!=}{a b}{}
Inequality comparison. This is functionally the same as inverting the \inline{=} operator. \inline{a} and \inline{b} must be arguments.
\subsubsection{Query Form \inline{:>}, \inline{:<}, \inline{:<=}, \inline{:>=}}
\funcdef{:>/:</:<=/:>=}{a b}{}
Numerical comparison, same as their \inline{cl} equivalents. \inline{a} and \inline{b} must be arguments.
\subsubsection{Query Form \inline{:MATCHES}}
\funcdef{:MATCHES}{a b}{}
Matches \inline{a} against a regex form \inline{b}. The precise regular expression capabilities depend on the implementation, but basic PCRE should be supported.
\inline{a} and \inline{b} must be arguments.
\subsubsection{Query Form \inline{:IN}}
\funcdef{:IN}{a \&rest arguments}{}
Checks if \inline{a} is \inline{=} to one of the provided \inline{arguments}.
\inline{a} and \inline{arguments} must be arguments.
\subsubsection{Query Form \inline{:AND}}
\funcdef{:AND}{\&rest query-forms}{}
Evaluates to true if every sub-form is true.
\inline{query-forms} must be query forms.
\subsubsection{Query Form \inline{:OR}}
\funcdef{:OR}{\&rest query-forms}{}
Evaluates to true if one of the sub-forms is true.
\inline{query-forms} must be query forms.
\subsubsection{Query Form \inline{:NOT}}
\funcdef{:NOT}{query-form}{}
Evaluates to true if the sub-form evaluates to false and vice-versa.
\inline{query-form} must be a query form.
\subsubsection{Query Form \inline{QUOTE}, \inline{:FIELD}}
\funcdef{QUOTE/:FIELD}{value}{}
Translates to a reference to the collection's field, rather than a literal argument value. The \inline{value} may either be a \inline{symbol} or a \inline{string}; in the case of a symbol the symbol's name is used. The field name is forced to lowercase.
\subsubsection{Keyword \inline{:ALL}}
Translates into ``no query restriction'' or simply ``all records''.
%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "master"
%%% End: 
